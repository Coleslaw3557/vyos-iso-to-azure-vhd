packer {
  required_plugins {
    qemu = {
      version = ">= 1.0.10"
      source  = "github.com/hashicorp/qemu"
    }
  }
}

variable "iso_url" {
  type    = string
  default = "file://{{ artifacts_folder }}/{{ iso_folder }}/{{ vyos_rolling_iso }}"
}

variable "iso_checksum" {
  type    = string
  default = "{{ iso_checksum }}"
}

variable "output_dir" {
  type    = string
  default = "{{ artifacts_folder }}/{{ images_folder }}"
}

variable "image_name" {
  type    = string
  default = "{{ packer_vyos_image }}"
}

source "qemu" "vyos_rolling" {
  iso_url          = var.iso_url
  iso_checksum     = var.iso_checksum
  communicator     = "none"
  disk_size        = "20G"
  format           = "qcow2"
  memory           = 512
  cpus             = 1
  headless         = true
  accelerator      = "kvm"
  vm_name          = var.image_name
  net_device       = "virtio-net"
  disk_interface   = "virtio"
  vnc_bind_address = "0.0.0.0"
  boot_wait        = "90s"
  qemuargs         = [
    ["-serial", "file:{{ artifacts_folder }}/serial.log"]
  ]
  boot_command     = [
    "<wait5>",
    "vyos<enter><wait>",
    "vyos<enter><wait3>",
    "install image<enter><wait>",
    "y<enter><wait>",
    "<enter><wait>",
    "vyos<enter><wait>",
    "vyos<enter><wait>",
    "<enter><wait10>",
    "<enter><wait>",
    "y<enter><wait>",
    "Y<enter><wait5>",
    "<enter><wait90>",
    "poweroff now<enter>"
  ]
  output_directory = var.output_dir
}

build {
  sources = ["source.qemu.vyos_rolling"]
}